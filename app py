import os
import pandas as pd
from io import BytesIO
from datetime import datetime, timedelta
from flask import Flask, render_template, request, redirect, url_for, send_file, flash, session, jsonify
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager, UserMixin, login_user, login_required, logout_user, current_user
from werkzeug.security import generate_password_hash, check_password_hash

app = Flask(__name__)

# --- ТОХИРГОО ---
app.config['SQLALCHEMY_DATABASE_URI'] = "postgresql://neondb_owner:npg_J8h1MnAQlbPK@ep-mute-river-a1c92rpd-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require"
app.config['SECRET_KEY'] = 'Sodoo123'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)
login_manager = LoginManager(app)
login_manager.login_view = 'login'

# --- МОДЕЛЬ ХЭСЭГ ---
class User(UserMixin, db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(150), unique=True, nullable=False)
    password = db.Column(db.String(150), nullable=False)
    role = db.Column(db.String(50), default='user')

class Product(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    sku = db.Column(db.String(50), unique=True, nullable=False)
    name = db.Column(db.String(100), nullable=False)
    category = db.Column(db.String(50))
    cost_price = db.Column(db.Float, default=0.0)
    retail_price = db.Column(db.Float, default=0.0)
    wholesale_price = db.Column(db.Float, default=0.0)
    stock = db.Column(db.Float, default=0.0)
    is_active = db.Column(db.Boolean, default=True)

class Transaction(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    product_id = db.Column(db.Integer, db.ForeignKey('product.id'))
    type = db.Column(db.String(100))
    quantity = db.Column(db.Float)
    timestamp = db.Column(db.DateTime, default=datetime.now) # Энд 'timestamp' гэж байна
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'))
    product = db.relationship('Product', backref='transactions')
    user = db.relationship('User', backref='transactions')

class Expense(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    category = db.Column(db.String(50), nullable=False)
    amount = db.Column(db.Float, nullable=False)
    description = db.Column(db.Text)
    date = db.Column(db.DateTime, default=datetime.now)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'))

@login_manager.user_loader
def load_user(user_id):
    return User.query.get(int(user_id))

# --- ҮНДСЭН ХУУДАСНУУД ---
@app.route('/')
@login_required
def dashboard():
    products = Product.query.filter_by(is_active=True).all()
    categories = db.session.query(Product.category).distinct().all()
    categories = [c[0] for c in categories if c[0]]
    return render_template('dashboard.html', products=products, categories=categories)

@app.route('/cart')
@login_required
def cart_page():
    return render_template('cart.html')

@app.route('/add_transaction_bulk', methods=['POST'])
@login_required
def add_transaction_bulk():
    data = request.json
    items = data.get('items', [])
    if not items: return jsonify({"status": "error"}), 400
    
    for item in items:
        product = Product.query.get(item['product_id'])
        if product:
            qty = float(item['quantity'])
            if item['type'] == 'Орлого':
                product.stock += qty
            else:
                product.stock -= qty
            
            # АЛДАА ЗАССАН: 'date' биш 'timestamp' гэж бичнэ
            db.session.add(Transaction(
                product_id=product.id,
                type=item['type'],
                quantity=qty,
                timestamp=datetime.now(), 
                user_id=current_user.id
            ))
    db.session.commit()
    flash(f"{len(items)} гүйлгээ амжилттай бүртгэгдлээ.")
    return jsonify({"status": "success"}), 200

# --- ТАЙЛАН ТАТАХ (EXPORT) ---
@app.route('/export-transactions/<type>')
@login_required
def export_transactions(type):
    start_date = request.args.get('start_date')
    end_date = request.args.get('end_date')
    query = Transaction.query.filter(Transaction.type == type)
    if start_date: query = query.filter(Transaction.timestamp >= datetime.strptime(start_date, '%Y-%m-%d'))
    if end_date: query = query.filter(Transaction.timestamp <= datetime.strptime(end_date, '%Y-%m-%d') + timedelta(days=1))
    
    data = [{
        'Огноо': t.timestamp.strftime('%Y-%m-%d %H:%M'),
        'Бараа': t.product.name,
        'Тоо': t.quantity,
        'Ажилтан': t.user.username if t.user else "-"
    } for t in query.all()]
    
    df = pd.DataFrame(data)
    output = BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False)
    output.seek(0)
    return send_file(output, as_attachment=True, download_name=f"{type}_Report.xlsx")

@app.route('/export-expense-report/<category>')
@login_required
def export_expense_report(category):
    start_date = request.args.get('start_date')
    end_date = request.args.get('end_date')
    query = Expense.query.filter(Expense.category == category)
    if start_date: query = query.filter(Expense.date >= datetime.strptime(start_date, '%Y-%m-%d'))
    if end_date: query = query.filter(Expense.date <= datetime.strptime(end_date, '%Y-%m-%d') + timedelta(days=1))
    
    data = [{'Огноо': e.date.strftime('%Y-%m-%d'), 'Тайлбар': e.description, 'Дүн': e.amount} for e in query.all()]
    df = pd.DataFrame(data)
    output = BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False)
    output.seek(0)
    return send_file(output, as_attachment=True, download_name=f"{category}_Report.xlsx")

@app.route('/export-balance')
@login_required
def export_balance():
    products = Product.query.all()
    df = pd.DataFrame([{'SKU': p.sku, 'Нэр': p.name, 'Үлдэгдэл': p.stock} for p in products])
    output = BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False)
    output.seek(0)
    return send_file(output, as_attachment=True, download_name="Current_Balance.xlsx")

# (Бусад шаардлагатай маршрутууд: login, logout, inventory, expenses, statistics г.м хэвээрээ байна)
# ... [Таны өмнөх app.py дээрх бусад функцүүд] ...

if __name__ == '__main__':
    with app.app_context():
        db.create_all()
    app.run(debug=True)
