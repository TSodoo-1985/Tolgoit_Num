{% extends "layout.html" %}
{% block content %}
<div class="row g-3 mb-4">
    <div class="col-md-8"><input type="text" id="pSearch" class="form-control" placeholder="Хайх..." onkeyup="filter()"></div>
    <div class="col-md-4">
        <select id="pCat" class="form-select" onchange="filter()">
            <option value="">Бүх төрөл</option>
            {% for c in categories %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
        </select>
    </div>
</div>

<div class="row" id="pGrid">
    {% for p in products %}
    <div class="col-md-4 mb-3 p-item" data-cat="{{ p.category }}">
        <div class="card p-3 shadow-sm border-0">
            <div class="d-flex justify-content-between">
                <span class="badge bg-dark">{{ p.sku }}</span>
                <span class="badge bg-success">{{ p.stock|int }} ш</span>
            </div>
            <h6 class="mt-2 fw-bold text-truncate">{{ p.name }}</h6>
            <div class="d-flex gap-1 mt-2">
                <input type="number" id="q-{{ p.id }}" class="form-control form-control-sm" placeholder="Тоо" style="width:70px">
                <select id="t-{{ p.id }}" class="form-select form-select-sm">
                    <option value="Жижиглэн зарлага">Жижиглэн</option>
                    <option value="Бөөний зарлага">Бөөний</option>
                    <option value="Орлого">Орлого</option>
                </select>
                <button onclick="add('{{ p.id }}', '{{ p.name }}')" class="btn btn-primary btn-sm"><i class="bi bi-cart-plus"></i></button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
    function add(id, name) {
        const q = document.getElementById('q-'+id).value;
        const t = document.getElementById('t-'+id).value;
        if(!q || q <= 0) return alert("Тоо оруулна уу");

        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        cart.push({ product_id: id, name: name, quantity: q, type: t });
        localStorage.setItem('myCart', JSON.stringify(cart));
        updateBadge();
        document.getElementById('q-'+id).value = '';
        alert("Сагсанд нэмэгдлээ");
    }

    function filter() {
        let s = document.getElementById('pSearch').value.toLowerCase();
        let c = document.getElementById('pCat').value;
        document.querySelectorAll('.p-item').forEach(el => {
            let matches = el.innerText.toLowerCase().includes(s) && (c === "" || el.dataset.cat === c);
            el.style.display = matches ? "block" : "none";
        });
    }
</script>
{% endblock %}
