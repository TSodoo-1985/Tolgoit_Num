{% extends "layout.html" %}
{% block content %}

<style>
    .product-card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #e2e8f0; position: relative; }
    .sku-tag { background: #334155; color: white; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; }
    .cat-tag { background: #e2e8f0; color: #64748b; padding: 2px 8px; border-radius: 4px; font-weight: 600; font-size: 0.75rem; margin-left: 5px; }
    .price-box { background: #f8fafc; border-radius: 8px; padding: 8px; font-size: 0.85rem; border: 1px dashed #cbd5e1; margin-top: 10px; }
    .qty-input-box { width: 75px; text-align: center; font-weight: bold; border: 2px solid #0d6efd; border-radius: 8px; }
    .animate-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    
    .action-btns { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; opacity: 0.3; transition: opacity 0.3s; }
    .product-card:hover .action-btns { opacity: 1; }
    .btn-action { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 0.8rem; padding: 0; }

    /* Сагсны шинэ стиль - Таны загварт нийцүүлсэн */
    #cart-sticky { position: fixed; bottom: 20px; right: 20px; width: 320px; z-index: 1050; display: none; }
    .cart-container { background: white; border-radius: 15px; border: 2px solid #0d6efd; max-height: 450px; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .cart-item { font-size: 0.85rem; border-bottom: 1px solid #eee; padding: 8px 0; }
</style>

<div class="row g-2 mb-3">
    <div class="col-8">
        <input type="text" id="mainSearch" class="form-control border-0 shadow-sm" placeholder="Бараа хайх..." onkeyup="filterProducts()">
    </div>
    <div class="col-4">
        <select id="catFilter" class="form-select border-0 shadow-sm fw-bold" onchange="filterProducts()">
            <option value="">Бүх төрөл</option>
            {% for c in categories %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
        </select>
    </div>
</div>

<div class="row" id="productContainer">
    {% for p in products %}
    <div class="col-12 col-md-6 col-lg-4 item-to-filter" data-category="{{ p.category }}">
        <div class="product-card shadow-sm">
            
            <div class="action-btns">
                <a href="{{ url_for('edit_product', id=p.id) }}" class="btn btn-light btn-action border shadow-sm text-primary" title="Засах">
                    <i class="bi bi-pencil-fill"></i>
                </a>
                {% if current_user.role == 'admin' %}
                <form action="{{ url_for('delete_product', id=p.id) }}" method="POST" onsubmit="return confirm('Та «{{ p.name }}» барааг устгахдаа итгэлтэй байна уу? Сэргээх боломжгүй.');">
                    <button type="submit" class="btn btn-light btn-action border shadow-sm text-danger" title="Устгах">
                        <i class="bi bi-trash3-fill"></i>
                    </button>
                </form>
                {% endif %}
            </div>

            <div class="d-flex justify-content-between align-items-start mb-2" style="padding-right: 60px;">
                <div>
                    <span class="sku-tag">{{ p.sku }}</span>
                    <span class="cat-tag">{{ p.category }}</span>
                    <h6 class="fw-bold mt-2 mb-0 text-dark">{{ p.name }}</h6>
                </div>
                <div class="badge {% if p.stock <= 5 %}bg-danger animate-pulse{% else %}bg-success{% endif %} p-2 rounded-3">
                    {{ p.stock|int }} ш
                </div>
            </div>

            <div class="price-box d-flex justify-content-between text-dark">
                <span>Жижиглэн: <b>{{ "{:,.0f}".format(p.retail_price or 0) }}₮</b></span>
                <span>Бөөний: <b>{{ "{:,.0f}".format(p.wholesale_price or 0) }}₮</b></span>
            </div>

            <div class="d-flex gap-2 mt-3">
                <input type="number" step="0.1" id="qty-{{ p.id }}" class="form-control qty-input-box" placeholder="Тоо">
                <select id="type-{{ p.id }}" class="form-select fw-bold flex-grow-1 border-2">
                    <option value="Жижиглэн зарлага" data-price="{{ p.retail_price or 0 }}">Жижиглэн</option>
                    <option value="Бөөний зарлага" data-price="{{ p.wholesale_price or 0 }}">Бөөний</option>
                    <option value="Орлого" data-price="0">Орлого</option>
                </select>
                <button type="button" onclick="addToCart('{{ p.id }}', '{{ p.name }}')" class="btn btn-primary px-3 shadow-sm"><i class="bi bi-cart-plus"></i></button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div id="cart-sticky">
    <div class="cart-container p-3">
        <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
            <h6 class="m-0 fw-bold text-primary"><i class="bi bi-cart4"></i> Сагс</h6>
            <button onclick="clearCart()" class="btn btn-sm btn-outline-danger border-0"><i class="bi bi-trash"></i></button>
        </div>
        <div id="cart-items-list"></div>
        <div class="mt-3 pt-2 border-top">
            <div class="d-flex justify-content-between fw-bold mb-2">
                <span>Нийт дүн:</span>
                <span id="cart-total-price" class="text-success">0₮</span>
            </div>
            <button onclick="submitCart()" class="btn btn-success w-100 fw-bold py-2 shadow-sm">БОРЛУУЛАХ</button>
        </div>
    </div>
</div>

<script>
    let cart = [];

    function addToCart(pId, pName) {
        const qtyInput = document.getElementById(`qty-${pId}`);
        const typeSelect = document.getElementById(`type-${pId}`);
        const price = parseFloat(typeSelect.options[typeSelect.selectedIndex].getAttribute('data-price'));
        
        if (!qtyInput.value || qtyInput.value <= 0) {
            alert("Тоо ширхэг оруулна уу!");
            return;
        }

        cart.push({
            product_id: pId,
            name: pName,
            quantity: parseFloat(qtyInput.value),
            type: typeSelect.value,
            price: price,
            subtotal: price * parseFloat(qtyInput.value)
        });

        updateCartUI();
        qtyInput.value = ''; 
    }

    function updateCartUI() {
        const cartDiv = document.getElementById('cart-sticky');
        const listDiv = document.getElementById('cart-items-list');
        const totalSpan = document.getElementById('cart-total-price');
        
        if (cart.length > 0) {
            cartDiv.style.display = 'block';
            let total = 0;
            listDiv.innerHTML = cart.map((item, index) => {
                total += item.subtotal;
                return `
                <div class="cart-item d-flex justify-content-between align-items-center">
                    <span><b>${item.quantity}</b> ш - ${item.name}</span>
                    <div>
                        <span class="me-2">${item.subtotal.toLocaleString()}₮</span>
                        <i class="bi bi-x-circle text-danger" style="cursor:pointer" onclick="removeFromCart(${index})"></i>
                    </div>
                </div>`;
            }).join('');
            totalSpan.innerText = total.toLocaleString() + '₮';
        } else {
            cartDiv.style.display = 'none';
        }
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCartUI();
    }

    function clearCart() {
        cart = [];
        updateCartUI();
    }

    async function submitCart() {
        if (!confirm("Гүйлгээг баталгаажуулах уу?")) return;
        const response = await fetch('/add_transaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: cart })
        });
        const result = await response.json();
        if (result.success) { location.reload(); } else { alert("Алдаа: " + result.message); }
    }

    function filterProducts() {
        let searchInput = document.getElementById('mainSearch').value.toLowerCase();
        let catSelect = document.getElementById('catFilter').value;
        let items = document.querySelectorAll('.item-to-filter');
        items.forEach(item => {
            let text = item.innerText.toLowerCase();
            let itemCat = item.getAttribute('data-category');
            item.style.display = (text.includes(searchInput) && (catSelect === "" || itemCat === catSelect)) ? "block" : "none";
        });
    }
</script>
{% endblock %}
