{% extends "layout.html" %}
{% block content %}

<style>
    .sticky-search-wrapper {
        position: -webkit-sticky;
        position: sticky;
        top: 58px;
        z-index: 1010;
        background-color: #f0f2f5;
        margin: -1rem -1rem 1rem -1rem;
        padding: 1rem 1rem;
    }
    .small-label { font-size: 9px; font-weight: bold; letter-spacing: 0.5px; }
    .card { transition: transform 0.2s; border-radius: 15px; border: none !important; }
    .bg-light-custom { background-color: #f8f9fa !important; border-radius: 12px; }
</style>

<div class="sticky-search-wrapper">
    <div class="row g-2">
        <div class="col-8">
            <input type="text" id="mainSearch" class="form-control border-0 shadow-sm" placeholder="Бараа хайх..." onkeyup="filterProducts()">
        </div>
        <div class="col-4">
            <select id="catFilter" class="form-select border-0 shadow-sm fw-bold" onchange="filterProducts()">
                <option value="">Бүх төрөл</option>
                {% for c in categories %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
            </select>
        </div>
    </div>
</div>

<div class="row" id="productContainer">
    {% for p in products %}
    <div class="col-12 col-md-6 col-lg-4 item-to-filter" data-category="{{ p.category }}">
        <div class="card shadow-sm p-3 mb-3">
            
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div style="flex: 1;">
                    <div class="mb-1">
                        <span class="badge bg-dark small">{{ p.sku }}</span>
                        {% if p.category %}
                        <span class="badge bg-light text-secondary border ms-1">{{ p.category }}</span>
                        {% endif %}
                    </div>
                    
                    <h6 class="fw-bold mt-2 mb-0 text-dark">{{ p.name }}</h6>
                    
                    {% if current_user.role != 'viewer' %}
                    <div class="mt-2 d-flex gap-3">
                        <a href="{{ url_for('edit_product', id=p.id) }}" class="text-decoration-none small text-primary">
                            <i class="bi bi-pencil-square"></i> Засах
                        </a>
                        <a href="{{ url_for('delete_product', id=p.id) }}" class="text-decoration-none small text-danger" onclick="return confirm('Устгах уу?')">
                            <i class="bi bi-trash"></i> Устгах
                        </a>
                    </div>
                    {% endif %}
                </div>

                <div class="text-end">
                    <small class="text-muted d-block small-label">ҮЛДЭГДЭЛ</small>
                    <span class="badge {{ 'bg-success' if p.stock > 10 else 'bg-danger' }} fs-6 rounded-pill">
                        {{ "{:,.0f}".format(p.stock) }} {{ p.unit }}
                    </span>
                </div>
            </div>

            <div class="row g-1 mb-2 bg-light-custom p-2">
                <div class="col-12 text-center">
                    <small class="d-block text-muted" style="font-size: 10px;">ЖИЖИГЛЭН ҮНЭ</small>
                    <div class="fw-bold text-primary fs-5">{{ "{:,.0f}".format(p.retail_price) }}₮</div>
                </div>
                
                {% if current_user.role != 'viewer' %}
                <div class="col-12 border-top mt-1 pt-1 text-center">
                    <small class="d-block text-muted" style="font-size: 10px;">БӨӨНИЙ ҮНЭ</small>
                    <div class="fw-bold text-dark">{{ "{:,.0f}".format(p.wholesale_price) }}₮</div>
                </div>
                {% endif %}
            </div>

            {% if current_user.role != 'viewer' %}
            <div class="input-group input-group-sm mt-2">
                <select id="type-{{ p.id }}" class="form-select border-2 fw-bold">
                    <option value="Жижиглэн зарлага">Жижиглэн</option>
                    <option value="Бөөний зарлага">Бөөний</option>
                    <option value="Орлого">Орлого</option>
                </select>
                <input type="number" id="qty-{{ p.id }}" class="form-control border-2 text-center fw-bold" placeholder="Тоо">
                <button type="button" onclick="addToCartLocal('{{ p.id }}', '{{ p.name }}', {{ p.retail_price }}, {{ p.wholesale_price }})" class="btn btn-primary">
                    <i class="bi bi-cart-plus"></i>
                </button>
            </div>
            {% endif %}
            
        </div>
    </div>
    {% endfor %}
</div>

<script>
    function filterProducts() {
        let s = document.getElementById('mainSearch').value.toLowerCase();
        let c = document.getElementById('catFilter').value;
        document.querySelectorAll('.item-to-filter').forEach(item => {
            let t = item.innerText.toLowerCase();
            let matches = t.includes(s) && (c === "" || item.dataset.category === c);
            item.style.display = matches ? 'block' : 'none';
        });
    }

    function addToCartLocal(id, name, retail, wholesale) {
        const qtyInp = document.getElementById(`qty-${id}`);
        const typeInp = document.getElementById(`type-${id}`);
        let qty = parseInt(qtyInp.value, 10);
        if (!qty || qty <= 0) { alert("Тоо оруулна уу!"); return; }

        let price = (typeInp.value === "Бөөний зарлага") ? wholesale : retail;
        if (typeInp.value === "Орлого") price = 0;

        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        cart.push({ product_id: id, name: name, quantity: qty, type: typeInp.value, price: price });
        localStorage.setItem('myCart', JSON.stringify(cart));
        
        if (window.updateBadge) window.updateBadge();
        qtyInp.value = '';
        alert(name + " сагсанд нэмэгдлээ!");
    }
</script>
{% endblock %}
