{% extends "layout.html" %}
{% block content %}

<style>
    .sticky-bundle-search {
        position: -webkit-sticky;
        position: sticky;
        top: 58px;
        z-index: 1010;
        background-color: #f0f2f5;
        margin: -1rem -1rem 1rem -1rem;
        padding: 1rem 1rem;
    }
    .card { border-radius: 15px; border: none; }
    .bundle-item-row { border-bottom: 1px solid #eee; padding: 10px 0; }
    .bundle-item-row:last-child { border-bottom: none; }
</style>

<div class="sticky-bundle-search shadow-sm">
    <div class="input-group">
        <span class="input-group-text bg-white border-0"><i class="bi bi-search text-primary"></i></span>
        <input type="text" id="bundleSearch" class="form-control border-0" placeholder="Бараа хайх..." onkeyup="filterBundleProducts()">
    </div>
</div>

<div class="row">
    <div class="col-12 col-lg-5 mb-3">
        <h6 class="fw-bold mb-3 text-uppercase small text-muted"><i class="bi bi-list-ul me-1"></i> Барааны жагсаалт</h6>
        <div id="bundleProductList" style="max-height: 450px; overflow-y: auto; padding-right: 5px;">
            {% for p in products %}
            <div class="card p-3 mb-2 shadow-sm bundle-product-card" data-name="{{ p.name }}" data-sku="{{ p.sku }}">
                <div class="d-flex justify-content-between align-items-center">
                    <div onclick="addItemToBundle('{{ p.id }}', '{{ p.name }}')" style="cursor:pointer; flex: 1;">
                        <span class="badge bg-dark mb-1">{{ p.sku }}</span>
                        <h6 class="mb-0 fw-bold">{{ p.name }}</h6>
                        <small class="text-muted">{{ "{:,.0f}".format(p.retail_price) }}₮ | Үлдэгдэл: {{ p.stock }}</small>
                    </div>
                    <button class="btn btn-primary btn-sm rounded-3" onclick="addItemToBundle('{{ p.id }}', '{{ p.name }}')">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="col-12 col-lg-7">
        <div class="card p-4 shadow-sm mb-4 border-top border-primary border-4">
            <h5 class="fw-bold mb-3"><i class="bi bi-cart-check-fill text-primary"></i> Багц бүрдүүлэлт</h5>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="small fw-bold text-muted">БАГЦЫН НЭР</label>
                    <input type="text" id="bundleName" class="form-control border-2" placeholder="Жишээ: Комбо-1">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="small fw-bold text-muted">БАГЦЫН КОД (SKU)</label>
                    <input type="text" id="bundleSKU" class="form-control border-2 text-uppercase" placeholder="Жишээ: BDL-001">
                </div>
            </div>

            <div id="selectedItemsContainer" class="mb-4">
                <p class="text-center text-muted py-3 border rounded-3 bg-light small">Бараа сонгоогүй байна</p>
            </div>

            <div class="bg-light p-3 rounded-4 mb-4 text-center">
                <small class="fw-bold text-muted d-block mb-1">НИЙТ ЗАРАХ ҮНЭ</small>
                <input type="number" id="bundlePrice" class="form-control form-control-lg border-0 bg-transparent text-center fw-bold text-success" placeholder="0 ₮" style="font-size: 1.8rem;">
            </div>

            <div class="row g-2">
                <div class="col-6">
                    <button class="btn btn-outline-success w-100 py-3 fw-bold rounded-3" onclick="saveBundle()">
                        <i class="bi bi-save"></i> ХАДГАЛАХ
                    </button>
                </div>
                <div class="col-6">
                    <button class="btn btn-primary w-100 py-3 fw-bold shadow rounded-3" onclick="sellNow()">
                        <i class="bi bi-cart-plus"></i> САГСЛАХ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedItems = [];

function filterBundleProducts() {
    let s = document.getElementById('bundleSearch').value.toLowerCase();
    document.querySelectorAll('.bundle-product-card').forEach(card => {
        let text = card.dataset.name.toLowerCase() + card.dataset.sku.toLowerCase();
        card.style.display = text.includes(s) ? 'block' : 'none';
    });
}

function addItemToBundle(id, name) {
    let existing = selectedItems.find(i => i.product_id === id);
    if (existing) {
        existing.quantity += 1;
    } else {
        selectedItems.push({ product_id: id, name: name, quantity: 1 });
    }
    renderBundle();
}

function renderBundle() {
    const container = document.getElementById('selectedItemsContainer');
    if (selectedItems.length === 0) {
        container.innerHTML = '<p class="text-center text-muted py-3 border rounded-3 bg-light small">Бараа сонгоогүй байна</p>';
        return;
    }

    let html = '';
    selectedItems.forEach(item => {
        html += `
        <div class="bundle-item-row d-flex justify-content-between align-items-center">
            <div style="flex: 2;">
                <h6 class="mb-0 fw-bold small">${item.name}</h6>
            </div>
            <div class="d-flex align-items-center" style="flex: 1;">
                <input type="number" class="form-control form-control-sm text-center fw-bold border-2" 
                    value="${item.quantity}" step="0.1" 
                    onchange="updateQty('${item.product_id}', this.value)" style="width: 70px;">
                <button class="btn btn-link text-danger ms-2" onclick="removeItem('${item.product_id}')">
                    <i class="bi bi-x-circle-fill"></i>
                </button>
            </div>
        </div>`;
    });
    container.innerHTML = html;
}

function updateQty(id, qty) {
    let item = selectedItems.find(i => i.product_id === id);
    if (item) item.quantity = parseFloat(qty);
}

function removeItem(id) {
    selectedItems = selectedItems.filter(i => i.product_id !== id);
    renderBundle();
}

function sellNow() {
    const name = document.getElementById('bundleName').value || "Шинэ багц";
    // SKU дээр санамсаргүй тоо нэмэхгүй бол дараа нь давхардал үүснэ
    const sku = document.getElementById('bundleSKU').value || "BDL-" + Math.floor(Math.random() * 10000);
    const price = document.getElementById('bundlePrice').value;
    
    if (selectedItems.length === 0 || !price) { 
        alert("Бараа эсвэл үнэ дутуу байна!"); 
        return; 
    }

    let cart = JSON.parse(localStorage.getItem('myCart')) || [];
    
    // Багц бүрт давтагдахгүй ID өгөх (Unix timestamp ашиглав)
    // Энэ нь сагсанд олон өөр багц хийх боломжийг олгоно.
    let uniqueBundleId = "bundle_" + Date.now(); 

    cart.push({
        product_id: uniqueBundleId, // Түр ID (String байж болно, Frontend дээр)
        sku: sku,      
        name: name,
        quantity: 1,
        type: "Багц",
        price: Math.round(parseFloat(price)),
        is_bundle: true,
        bundle_items: selectedItems // Сонгосон бараанууд [{product_id, quantity, name}...]
    });

    localStorage.setItem('myCart', JSON.stringify(cart));
    
    // Badge шинэчлэх (Хэрэв байгаа бол)
    if (window.updateBadge) window.updateBadge();
    
    alert("Багц сагсанд нэмэгдлээ!");
    // Шууд сагс руу үсрэх
    window.location.href = "/cart"; 
}
    
function saveBundle() {
    const name = document.getElementById('bundleName').value;
    const price = document.getElementById('bundlePrice').value;
    const sku = document.getElementById('bundleSKU').value;

    if (!name || selectedItems.length === 0 || !price) { 
        alert("Мэдээлэл дутуу!"); 
        return; 
    }

    fetch('/create_bundle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            name: name, 
            sku: sku, // SKU кодыг сервер рүү илгээж байна
            set_price: price, 
            items: selectedItems 
        })
    }).then(res => res.json()).then(data => {
        if(data.status === 'success') location.reload();
        else alert(data.message);
    });
}
</script>
{% endblock %}
