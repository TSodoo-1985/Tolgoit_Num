{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üì¶ –ë–∞–≥—Ü–ª–∞—Ö & –ó–∞—Ä–∞—Ö</h2>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-sm">–ë—É—Ü–∞—Ö</a>
    </div>
    
    <div class="row">
        <div class="col-md-5">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">–ë–∞—Ä–∞–∞ –Ω—ç–º—ç—Ö</div>
                <div class="card-body">
                    <input type="text" id="bundleProductSearch" class="form-control mb-3" placeholder="–•–∞–π—Ö...">
                    <div id="productList" class="list-group" style="max-height: 400px; overflow-y: auto;">
                        {% for p in products %}
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                                onclick="addItemToBundle({{ p.id }}, '{{ p.name }}', {{ p.retail_price }})">
                            <span><strong>{{ p.name }}</strong></span>
                            <span class="badge badge-primary">{{ p.retail_price }}‚ÇÆ</span>
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card shadow-sm border-success h-100">
                <div class="card-header bg-success text-white">–û–¥–æ–æ–≥–∏–π–Ω –±–æ—Ä–ª—É—É–ª–∞–ª—Ç</div>
                <div class="card-body">
                    <div class="form-group">
                        <label>–ë–∞–≥—Ü—ã–Ω –Ω—ç—Ä:</label>
                        <input type="text" id="bundleName" class="form-control" placeholder="–ñ–∏—à—ç—ç: –ö–æ–º–±–æ-1">
                    </div>
                    
                    <table class="table table-sm" id="bundleItemsTable">
                        <thead>
                            <tr>
                                <th>–ë–∞—Ä–∞–∞</th>
                                <th width="100">–¢–æ–æ</th>
                                <th width="40"></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    
                    <div class="p-3 bg-light border rounded mb-3">
                        <label class="font-weight-bold">–ù–∏–π—Ç –∑–∞—Ä–∞—Ö “Ø–Ω—ç (‚ÇÆ):</label>
                        <input type="number" id="bundlePrice" class="form-control form-control-lg text-success" placeholder="0">
                    </div>
                    
                    <div class="row">
                        <div class="col"><button class="btn btn-outline-success btn-block" onclick="saveBundle()">–ó–∞–≥–≤–∞—Ä —Ö–∞–¥–≥–∞–ª–∞—Ö</button></div>
                        <div class="col"><button class="btn btn-primary btn-block" onclick="sellNow()">–®–£–£–î –ó–ê–†–ê–•</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <div class="card shadow-sm border-info">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-th-large"></i> –•–∞–¥–≥–∞–ª—Å–∞–Ω –±–∞–≥—Ü—ã–Ω –∑–∞–≥–≤–∞—Ä—É—É–¥
                </div>
                <div class="card-body bg-light">
                    <div class="d-flex flex-wrap" id="savedBundlesList">
                        {% if saved_bundles %}
                            {% for b in saved_bundles %}
                            <button class="btn btn-white border-info m-2 shadow-sm p-3 text-center" style="min-width: 150px;"
                                    onclick='loadBundleTemplate({{ {
                                        "name": b.name,
                                        "price": b.set_price,
                                        "items": b.items|map(attribute="product_id")|list,
                                        "item_names": b.items|map(attribute="product")|map(attribute="name")|list,
                                        "quantities": b.items|map(attribute="quantity")|list
                                    }|tojson }})'>
                                <strong class="text-info">{{ b.name }}</strong><br>
                                <span class="badge badge-info">{{ "{:,.0f}".format(b.set_price) }}‚ÇÆ</span>
                            </button>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted w-100 text-center">–ó–∞–≥–≤–∞—Ä —Ö–∞–¥–≥–∞–ª–∞–≥–¥–∞–∞–≥“Ø–π –±–∞–π–Ω–∞.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedItems = [];

// –ó–∞–≥–≤–∞—Ä –∞—á–∞–∞–ª–∞—Ö - –î–æ–æ—Ä–æ–æ—Å —Å–æ–Ω–≥–æ—Ö “Ø–µ–¥
function loadBundleTemplate(bundle) {
    document.getElementById('bundleName').value = bundle.name;
    document.getElementById('bundlePrice').value = bundle.price;
    selectedItems = [];
    
    for(let i=0; i < bundle.items.length; i++) {
        selectedItems.push({
            product_id: bundle.items[i],
            name: bundle.item_names[i],
            quantity: bundle.quantities[i]
        });
    }
    renderBundle();
}

function addItemToBundle(id, name, price) {
    let existing = selectedItems.find(i => i.product_id === id);
    if (existing) {
        existing.quantity += 1;
    } else {
        selectedItems.push({ product_id: id, name: name, quantity: 1 });
    }
    renderBundle();
}

function removeItem(id) {
    selectedItems = selectedItems.filter(i => i.product_id !== id);
    renderBundle();
}

function updateQty(id, qty) {
    let item = selectedItems.find(i => i.product_id === id);
    if (item) item.quantity = parseFloat(qty);
}

function renderBundle() {
    let tbody = document.querySelector('#bundleItemsTable tbody');
    if (selectedItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">–•–æ–æ—Å–æ–Ω</td></tr>';
        return;
    }
    let html = '';
    selectedItems.forEach(item => {
        html += `<tr>
            <td>${item.name}</td>
            <td><input type="number" class="form-control form-control-sm" value="${item.quantity}" step="0.1" onchange="updateQty(${item.product_id}, this.value)"></td>
            <td><button class="btn btn-sm text-danger" onclick="removeItem(${item.product_id})">√ó</button></td>
        </tr>`;
    });
    tbody.innerHTML = html;
}

function saveBundle() {
    const name = document.getElementById('bundleName').value;
    const price = document.getElementById('bundlePrice').value;
    if (!name || selectedItems.length === 0 || !price) { alert("–ú—ç–¥—ç—ç–ª—ç–ª –¥—É—Ç—É—É!"); return; }

    fetch('/create_bundle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name: name, set_price: price, items: selectedItems })
    }).then(res => res.json()).then(data => {
        if(data.status === 'success') location.reload();
        else alert(data.message);
    });
}

function sellNow() {
    const name = document.getElementById('bundleName').value || "–ë–∞–≥—Ü";
    const price = document.getElementById('bundlePrice').value;
    if (selectedItems.length === 0 || !price) { alert("–ë–∞—Ä–∞–∞/“Æ–Ω—ç –¥—É—Ç—É—É!"); return; }

    let desc = name + ": " + selectedItems.map(i => `${i.name}(${i.quantity})`).join(", ");
    const data = { items: [{ is_bundle: true, name: name, price: price, description: desc, bundle_items: selectedItems }] };

    if(!confirm("–ó–∞—Ä–∞—Ö —É—É?")) return;

    fetch('/add_transaction_bulk', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(res => res.json()).then(data => {
        if(data.status === 'success') { alert("–ó–∞—Ä–∞–≥–¥–ª–∞–∞!"); window.location.href = "/"; }
        else alert(data.message);
    });
}

document.getElementById('bundleProductSearch').addEventListener('input', function(e) {
    let filter = e.target.value.toLowerCase();
    document.querySelectorAll('#productList .list-group-item').forEach(item => {
        item.style.display = item.textContent.toLowerCase().includes(filter) ? '' : 'none';
    });
});

renderBundle();
</script>
{% endblock %}
