{% extends "layout.html" %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">üì¶ –ë–∞–≥—Ü–ª–∞—Ö & –ó–∞—Ä–∞—Ö</h4>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">–ë—É—Ü–∞—Ö</a>
    </div>
    
    <div class="row">
        <div class="col-12 col-md-5 mb-3">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white py-2">
                    <i class="fas fa-search"></i> –ë–∞—Ä–∞–∞ –Ω—ç–º—ç—Ö
                </div>
                <div class="card-body p-2">
                    <input type="text" id="bundleProductSearch" class="form-control mb-2" placeholder="–•–∞–π—Ö (–ù—ç—Ä, SKU)...">
                    <div id="productList" class="list-group" style="max-height: 250px; overflow-y: auto;">
                        {% for p in products %}
                        <button class="list-group-item list-group-item-action p-2" 
                                data-name="{{ p.name }}" 
                                data-sku="{{ p.sku }}"
                                onclick="addItemToBundle({{ p.id }}, '{{ p.name }}', {{ p.retail_price }})">
                            <div class="d-flex justify-content-between">
                                <strong>{{ p.name }}</strong>
                                <span class="text-primary font-weight-bold">{{ "{:,.0f}".format(p.retail_price) }}‚ÇÆ</span>
                            </div>
                            <small class="text-muted">“Æ–ª–¥—ç–≥–¥—ç–ª: {{ p.stock }} | SKU: {{ p.sku }}</small>
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-7 mb-4">
            <div class="card shadow-sm border-success">
                <div class="card-header bg-success text-white py-2">
                    <i class="fas fa-shopping-cart"></i> –ë–æ—Ä–ª—É—É–ª–∞–ª—Ç –±“Ø—Ä–¥“Ø“Ø–ª—ç–ª—Ç
                </div>
                <div class="card-body p-2">
                    <input type="text" id="bundleName" class="form-control mb-2" placeholder="–ë–∞–≥—Ü—ã–Ω –Ω—ç—Ä (–ó–∞–∞–≤–∞–ª –±–∏—à)">
                    
                    <div class="table-responsive">
                        <table class="table table-sm" id="bundleItemsTable">
                            <thead class="bg-light">
                                <tr>
                                    <th>–ë–∞—Ä–∞–∞</th>
                                    <th width="80">–¢–æ–æ</th>
                                    <th width="30"></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    
                    <div class="bg-light p-2 border rounded mb-3 text-center">
                        <small class="text-muted d-block text-uppercase">–ù–∏–π—Ç –∑–∞—Ä–∞—Ö “Ø–Ω—ç</small>
                        <input type="number" id="bundlePrice" class="form-control form-control-lg text-center text-success font-weight-bold border-0 bg-transparent" placeholder="0 ‚ÇÆ">
                    </div>
                    
                    <div class="row no-gutters">
                        <div class="col-6 pr-1">
                            <button class="btn btn-outline-success btn-block" onclick="saveBundle()">üíæ –•–∞–¥–≥–∞–ª–∞—Ö</button>
                        </div>
                        <div class="col-6 pl-1">
                            <button class="btn btn-primary btn-block font-weight-bold" onclick="sellNow()">üí∞ –ó–ê–†–ê–•</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-info bg-light">
                <div class="card-header bg-info text-white py-2 font-weight-bold">
                    <i class="fas fa-th-large"></i> –ë—ç–ª—ç–Ω –∑–∞–≥–≤–∞—Ä—É—É–¥
                </div>
                <div class="card-body p-2">
                    <div class="d-flex flex-nowrap overflow-auto py-2" id="savedBundlesList" style="-webkit-overflow-scrolling: touch;">
                        {% if saved_bundles %}
                            {% for b in saved_bundles %}
                            <div class="mr-2">
                                <button class="btn btn-white border-info shadow-sm p-2 text-center" style="min-width: 130px; border-width: 2px;"
                                        onclick='loadBundleTemplate({{ {
                                            "name": b.name,
                                            "price": b.set_price,
                                            "items": b.items|map(attribute="product_id")|list,
                                            "item_names": b.items|map(attribute="product")|map(attribute="name")|list,
                                            "quantities": b.items|map(attribute="quantity")|list
                                        }|tojson }})'>
                                    <span class="d-block font-weight-bold text-truncate text-info" style="max-width: 110px;">{{ b.name }}</span>
                                    <span class="badge badge-info">{{ "{:,.0f}".format(b.set_price) }}‚ÇÆ</span>
                                </button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <small class="text-muted ml-2">–ó–∞–≥–≤–∞—Ä –±–∞–π—Ö–≥“Ø–π.</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* –ì–∞—Ä —É—Ç—Å–∞–Ω–¥ –∑–æ—Ä–∏—É–ª—Å–∞–Ω —Ç—É—Å–≥–∞–π —Å—Ç–∏–ª—å */
    @media (max-width: 768px) {
        .container-fluid { padding-left: 10px; padding-right: 10px; }
        .btn-lg, .form-control-lg { font-size: 1.1rem; }
        .list-group-item { padding: 12px 8px; } /* –•—É—Ä—É—É–≥–∞–∞—Ä –¥–∞—Ä–∞—Ö–∞–¥ —Ö—è–ª–±–∞—Ä –±–æ–ª–≥–æ—Ö */
    }
    /* –ó–∞–≥–≤–∞—Ä—É—É–¥ —Ö”©–Ω–¥–ª”©–Ω–≥”©”©—Ä –≥“Ø–π–¥—ç–≥ –±–∞–π—Ö (Scroll) */
    #savedBundlesList::-webkit-scrollbar { height: 5px; }
    #savedBundlesList::-webkit-scrollbar-thumb { background: #17a2b8; border-radius: 10px; }
</style>

<script>
// ... (”®–º–Ω”©—Ö JS –∫–æ–¥—É—É–¥ —Ö—ç–≤—ç—ç—Ä—ç—ç –∞—à–∏–≥–ª–∞–≥–¥–∞–Ω–∞)
let selectedItems = [];

document.getElementById('bundleProductSearch').addEventListener('input', function(e) {
    let filter = e.target.value.toLowerCase().trim();
    document.querySelectorAll('#productList .list-group-item').forEach(item => {
        let name = item.getAttribute('data-name').toLowerCase();
        let sku = item.getAttribute('data-sku').toLowerCase();
        item.style.setProperty('display', (name.includes(filter) || sku.includes(filter)) ? 'block' : 'none', 'important');
    });
});

function addItemToBundle(id, name, price) {
    let existing = selectedItems.find(i => i.product_id === id);
    if (existing) existing.quantity += 1;
    else selectedItems.push({ product_id: id, name: name, quantity: 1 });
    renderBundle();
}

function loadBundleTemplate(bundle) {
    document.getElementById('bundleName').value = bundle.name;
    document.getElementById('bundlePrice').value = bundle.price;
    selectedItems = [];
    for(let i=0; i < bundle.items.length; i++) {
        selectedItems.push({ product_id: bundle.items[i], name: bundle.item_names[i], quantity: bundle.quantities[i] });
    }
    renderBundle();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function renderBundle() {
    let tbody = document.querySelector('#bundleItemsTable tbody');
    if (selectedItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">–•–æ–æ—Å–æ–Ω</td></tr>';
        return;
    }
    let html = '';
    selectedItems.forEach(item => {
        html += `<tr>
            <td class="small font-weight-bold">${item.name}</td>
            <td><input type="number" class="form-control form-control-sm" value="${item.quantity}" step="0.1" onchange="updateQty(${item.product_id}, this.value)"></td>
            <td class="text-right"><button class="btn btn-sm text-danger" onclick="removeItem(${item.product_id})">√ó</button></td>
        </tr>`;
    });
    tbody.innerHTML = html;
}

function updateQty(id, qty) {
    let item = selectedItems.find(i => i.product_id === id);
    if (item) item.quantity = parseFloat(qty);
}

function removeItem(id) {
    selectedItems = selectedItems.filter(i => i.product_id !== id);
    renderBundle();
}

function saveBundle() {
    const name = document.getElementById('bundleName').value;
    const price = document.getElementById('bundlePrice').value;
    if (!name || selectedItems.length === 0 || !price) { alert("–ú—ç–¥—ç—ç–ª—ç–ª –¥—É—Ç—É—É!"); return; }
    fetch('/create_bundle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name: name, set_price: price, items: selectedItems })
    }).then(res => res.json()).then(data => { if(data.status === 'success') location.reload(); });
}

function sellNow() {
    const name = document.getElementById('bundleName').value || "–ë–∞–≥—Ü";
    const price = document.getElementById('bundlePrice').value;
    if (selectedItems.length === 0 || !price) { alert("–ú—ç–¥—ç—ç–ª—ç–ª –¥—É—Ç—É—É!"); return; }
    let desc = name + ": " + selectedItems.map(i => `${i.name}(${i.quantity})`).join(", ");
    const data = { items: [{ is_bundle: true, name: name, price: price, description: desc, bundle_items: selectedItems }] };
    if(!confirm("–ó–∞—Ä–∞—Ö —É—É?")) return;
    fetch('/add_transaction_bulk', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(res => res.json()).then(data => {
        if(data.status === 'success') window.location.href = "/";
    });
}

renderBundle();
</script>
{% endblock %}
