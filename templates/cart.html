{% extends "layout.html" %}
{% block content %}
<div class="card border-0 shadow-sm rounded-4 p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold m-0"><i class="bi bi-cart-fill text-primary me-2"></i>Борлуулалтын сагс</h4>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Буцах</a>
    </div>
    
    <div id="cart-content">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Барааны нэр</th>
                        <th>Төрөл</th>
                        <th>Тоо ширхэг</th>
                        <th class="text-end">Устгах</th>
                    </tr>
                </thead>
                <tbody id="cart-items"></tbody>
            </table>
        </div>
        <div class="d-flex justify-content-between mt-4">
            <button onclick="emptyCart()" class="btn btn-danger">Сагс цэвэрлэх</button>
            <button onclick="checkout()" class="btn btn-success btn-lg px-5 fw-bold shadow">ГҮЙЛГЭЭ БАТЛАХ</button>
        </div>
    </div>

    <div id="cart-empty" class="text-center py-5" style="display:none;">
        <i class="bi bi-cart-x display-1 text-muted"></i>
        <h5 class="mt-3 text-muted">Сагс хоосон байна.</h5>
    </div>
</div>

<script>
    function renderCart() {
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        const tbody = document.getElementById('cart-items');
        const content = document.getElementById('cart-content');
        const empty = document.getElementById('cart-empty');

        if (cart.length === 0) {
            content.style.display = 'none';
            empty.style.display = 'block';
            return;
        }

        content.style.display = 'block';
        empty.style.display = 'none';
        tbody.innerHTML = cart.map((item, index) => `
            <tr>
                <td class="fw-bold">${item.name}</td>
                <td><span class="badge bg-info">${item.type}</span></td>
                <td><input type="number" class="form-control w-50" value="${item.quantity}" onchange="updateCartQty(${index}, this.value)"></td>
                <td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="removeItem(${index})"><i class="bi bi-trash"></i></button></td>
            </tr>
        `).join('');
    }

    function updateCartQty(index, val) {
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        cart[index].quantity = parseFloat(val);
        localStorage.setItem('myCart', JSON.stringify(cart));
    }

    function removeItem(index) {
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        cart.splice(index, 1);
        localStorage.setItem('myCart', JSON.stringify(cart));
        renderCart();
        updateBadge();
    }

    function emptyCart() {
        if(confirm("Сагсыг цэвэрлэх үү?")) {
            localStorage.removeItem('myCart');
            renderCart();
            updateBadge();
        }
    }

    async function checkout() {
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        if (cart.length === 0) return;
        if (!confirm("Гүйлгээг хадгалах уу?")) return;

        const res = await fetch('/add_transaction_bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: cart })
        });

        if (res.ok) {
            localStorage.removeItem('myCart');
            window.location.href = "{{ url_for('dashboard') }}";
        } else {
            alert("Алдаа гарлаа!");
        }
    }
    renderCart();
</script>
{% endblock %}
