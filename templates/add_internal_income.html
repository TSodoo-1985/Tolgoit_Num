{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <div class="card shadow-sm border-0 rounded-4 p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold text-success m-0"><i class="bi bi-box-arrow-in-down me-2"></i>Салбарын орлого авах</h4>
            <a href="{{ url_for('internal_income_list') }}" class="btn btn-outline-secondary btn-sm">Буцах</a>
        </div>
        
        <div class="row g-3 p-3 bg-light rounded-4 mb-4 align-items-end">
            <div class="col-md-7">
                <label class="form-label small fw-bold">Бараа хайх (SKU эсвэл Нэр)</label>
                <select id="p_select" class="form-select select2">
                    <option value="">Бараа сонгох...</option>
                    {% for p in products %}
                    <option value="{{ p.id }}" data-sku="{{ p.sku }}" data-name="{{ p.name }}" data-price="{{ p.cost_price }}">
                        {{ p.sku }} | {{ p.name }} (Үлдэгдэл: {{ p.stock }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold">Тоо</label>
                <input type="number" id="temp_qty" class="form-control" value="1" min="1">
            </div>
            <div class="col-md-3">
                <button type="button" onclick="addItem()" class="btn btn-success w-100">Нэмэх</button>
            </div>
        </div>

        <form method="POST">
            <div class="table-responsive">
                <table class="table table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Код</th>
                            <th>Нэр</th>
                            <th width="120">Тоо</th>
                            <th>Өртөг</th>
                            <th>Нийт</th>
                            <th width="50"></th>
                        </tr>
                    </thead>
                    <tbody id="incomeBody"></tbody>
                    <tfoot id="tableFooter" style="display: none;">
                        <tr class="table-dark">
                            <td colspan="4" class="text-end fw-bold">Нийт дүн:</td>
                            <td colspan="2" id="grandTotal" class="fw-bold text-warning">0₮</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div id="submitSection" style="display: none;" class="mt-4">
                <div class="mb-3">
                    <label class="form-label fw-bold small">Орлогын тайлбар (заавал биш)</label>
                    <textarea name="description" class="form-control" rows="2" placeholder="Жишээ: Төв салбараас ирсэн..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary btn-lg w-100 shadow">Бүгдийг хадгалах</button>
            </div>
        </form>
    </div>
</div>

<script>
$(document).ready(function() {
    $('.select2').select2({ theme: 'bootstrap-5', width: '100%' });

    window.addItem = function() {
        const sel = $('#p_select');
        const data = sel.select2('data')[0];
        const qty = $('#temp_qty').val();
        if (!sel.val()) return;

        const pId = sel.val();
        const pSku = data.element.dataset.sku;
        const pName = data.element.dataset.name;
        const pPrice = parseFloat(data.element.dataset.price);

        const row = `
            <tr class="fade-in">
                <td>${pSku}</td>
                <td>${pName}<input type="hidden" name="p_ids[]" value="${pId}"></td>
                <td><input type="number" name="qtys[]" class="form-control form-control-sm qty-input" value="${qty}" onchange="updateTotal()"></td>
                <td class="unit-price" data-price="${pPrice}">${pPrice.toLocaleString()}₮</td>
                <td class="row-total">${(qty * pPrice).toLocaleString()}₮</td>
                <td><button type="button" class="btn btn-link text-danger p-0" onclick="this.closest('tr').remove(); updateTotal();"><i class="bi bi-trash"></i></button></td>
            </tr>`;
        
        $('#incomeBody').append(row);
        $('#tableFooter, #submitSection').show();
        updateTotal();
        sel.val(null).trigger('change');
    };

    window.updateTotal = function() {
        let grand = 0;
        $('#incomeBody tr').each(function() {
            const q = $(this).find('.qty-input').val();
            const p = $(this).find('.unit-price').data('price');
            const rowT = q * p;
            $(this).find('.row-total').text(rowT.toLocaleString() + '₮');
            grand += rowT;
        });
        $('#grandTotal').text(grand.toLocaleString() + '₮');
        if($('#incomeBody tr').length === 0) $('#tableFooter, #submitSection').hide();
    };
});
</script>
{% endblock %}
